# Heroku+PostgreSQLアプリを作成する

## 設定を環境変数に置き換える

- ユーザー、パスワードなどは普通は直書きしてはいけないので環境変数から読み出すようにする
- 環境変数は`python-dotenv`をインストール済みなのでローカルでは`.env`で指定する

### Docker
`docker-compose.yml`
```yml
version: '3'

services:
  postgresql:
    container_name: mypostgres
    build: ./postgresql
    ports:
      - "5432:5432"
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD} # 変更
    restart: always
    # 追加
    volumes:
      - type: bind
        source: ./postgresql/init
        target: /docker-entrypoint-initdb.d
```
- [Compose における環境変数](https://matsuand.github.io/docs.docker.jp.onthefly/compose/environment-variables/)
- ↑ Dockerでは自動的に`.env`を読み込む設定になっている

### config.py
`myapp/config.py`
```python
import os

SECRET_KEY = os.getenv('MY_SECRET')
local_uri = 'postgresql://{user}:{pass}@{host}/{dbname}'.format(**{
    'user': os.getenv('DB_USERNAME', 'root'),
    'pass': os.getenv('DB_PASSWORD', ''),
    'host': os.getenv('DB_HOST', 'localhost'),
    'dbname': os.getenv('DB_NAME'),
})
SQLALCHEMY_DATABASE_URI = local_uri
SQLALCHEMY_TRACK_MODIFICATIONS = False
```
- `os.getenv()`で環境変数を読み出す。見つからなければNoneを返す。第二引数は第一引数がNoneだった場合のデフォルト値
- ちょっと参考：[Pythonのos.getenvとos.environ.getの違い](https://qiita.com/1ntegrale9/items/94ec4437f763aa623965)
- `SQLALCHEMY_TRACK_MODIFICATIONS`はターミナルで実行してるときに警告があったので入れている
- [Flask-SQLAlchemy Configuration](https://flask-sqlalchemy.palletsprojects.com/en/2.x/config/)

### .env
`.env`
```
FLASK_APP=myapp:app
FLASK_ENV=development
FLASK_RUN_PORT=5010

DB_USERNAME=postgres
DB_PASSWORD=pass
DB_HOST=localhost
DB_NAME=flasknote

MY_SECRET=dev
```
- `DB_`の環境変数にはDockerで動いているPostgreSQLの情報を入れる（`app/concig.py`でURIに組み立てる）
- `MY_SECRET`は開発中は簡単な値でいいがセッションなどで使用するので本番用はランダムな文字列やバイト列にすること
- [Flask config#SECRET_KEY](https://msiz07-flask-docs-ja.readthedocs.io/ja/latest/config.html#SECRET_KEY)

